<!DOCTYPE html>

<html>
<head>
  <title>build.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>build.js</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

module.exports = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(grunt)</span> {</span>
  <span class="hljs-keyword">var</span> _ = grunt.util._;
  <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

  grunt.registerTask(<span class="hljs-string">"phantomizer-html-jitbuild"</span>, <span class="hljs-string">"Builds html inlined request"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">( target, request )</span> {</span>

    <span class="hljs-keyword">var</span> build_assets = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">var</span> task_options = grunt.config(<span class="hljs-string">"phantomizer-html-jitbuild"</span>);

    <span class="hljs-keyword">var</span> options = {}
    grunt.util._.merge(options, task_options);

    <span class="hljs-keyword">if</span>( !options[target] )
      options[target] = {
        options:{}
      }

    options[target][<span class="hljs-string">"options"</span>][<span class="hljs-string">"request"</span>] = request;
    options[target][<span class="hljs-string">"options"</span>][<span class="hljs-string">"build_assets"</span>] = build_assets;

    grunt.config.set(<span class="hljs-string">"phantomizer-html-builder"</span>, options);
    grunt.task.run(<span class="hljs-string">"phantomizer-html-builder:"</span> + target);

  });

  grunt.registerMultiTask(<span class="hljs-string">"phantomizer-html-builder"</span>, <span class="hljs-string">"Builds html request"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

    <span class="hljs-keyword">var</span> _ = grunt.util._;
    <span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

    <span class="hljs-keyword">var</span> ph_libutil = <span class="hljs-built_in">require</span>(<span class="hljs-string">"phantomizer-libutil"</span>);

    <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>.options({
      out_path:<span class="hljs-string">''</span>,
      htmlcompressor:<span class="hljs-literal">false</span>,
      build_assets:<span class="hljs-literal">false</span>,
      in_request:<span class="hljs-string">''</span>
    });

    grunt.verbose.writeflags(options,<span class="hljs-string">"options"</span>);
    <span class="hljs-keyword">var</span> out_path = options.out_path;

    <span class="hljs-keyword">var</span> build_assets = options.build_assets;
    <span class="hljs-keyword">var</span> htmlcompressor = options.htmlcompressor;
    <span class="hljs-keyword">var</span> in_request = options.in_request;

    <span class="hljs-keyword">var</span> current_target = <span class="hljs-keyword">this</span>.target;

    <span class="hljs-keyword">var</span> in_request_tgt = in_request+<span class="hljs-string">"-"</span>+current_target;
    <span class="hljs-keyword">var</span> out_file = out_path+<span class="hljs-string">"/"</span>+in_request_tgt;

    <span class="hljs-keyword">var</span> sub_tasks = [];</pre></div>
        
      
        
        <p>get phantomizer main instance</p>

        
          <div class='highlight'><pre>    <span class="hljs-keyword">var</span> phantomizer = ph_libutil.get(<span class="hljs-string">"main"</span>);
    <span class="hljs-keyword">var</span> meta_manager = phantomizer.get_meta_manager();

    <span class="hljs-keyword">if</span>( meta_manager.is_fresh(in_request_tgt) == <span class="hljs-literal">false</span> ){</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>      queue_strykejs_builder( sub_tasks, current_target, in_request, in_request_tgt+<span class="hljs-string">".stryke"</span>, out_file+<span class="hljs-string">".stryke"</span> );
      grunt.log.ok(<span class="hljs-string">"Stryke task pushed "</span>);</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span>( build_assets ){
        queue_html_assets( sub_tasks, current_target, in_request, out_file+<span class="hljs-string">".stryke"</span>, in_request_tgt+<span class="hljs-string">".assets"</span>, out_file+<span class="hljs-string">".assets"</span>, out_path );
        grunt.log.ok(<span class="hljs-string">"assets build task pushed "</span>);
      }</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span>( htmlcompressor == <span class="hljs-literal">true</span> ){
        <span class="hljs-keyword">if</span>( build_assets ){
          queue_html_min(  sub_tasks, current_target, out_file+<span class="hljs-string">".min"</span>, in_request_tgt+<span class="hljs-string">".min"</span>, out_file+<span class="hljs-string">".assets"</span>, in_request );
        }<span class="hljs-keyword">else</span>{
          queue_html_min(  sub_tasks, current_target, out_file+<span class="hljs-string">".min"</span>, in_request_tgt+<span class="hljs-string">".min"</span>, out_file+<span class="hljs-string">".stryke"</span>, in_request );
        }
        grunt.log.ok(<span class="hljs-string">"HTMLcompressor task pushed "</span>);
      }</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>      queue_finalizer_builder( sub_tasks, in_request_tgt, out_file, build_assets, htmlcompressor );
      grunt.log.ok(<span class="hljs-string">"Finalizer task pushed "</span>);</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>      grunt.task.run( sub_tasks );

      grunt.log.ok(<span class="hljs-string">"Done "</span>);
    }<span class="hljs-keyword">else</span>{
      console.log(<span class="hljs-string">"Build is fresh ! -&gt; "</span> + in_request)
    }</pre></div>
        
      
        
        <p>â€” task queue-er</p>

        
          <div class='highlight'><pre>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_strykejs_builder</span><span class="hljs-params">( sub_tasks, current_target, in_request, meta_file, out_file )</span>{</span>
      <span class="hljs-keyword">var</span> current_sub_task_name = <span class="hljs-string">"phantomizer-strykejs-builder"</span>;
      <span class="hljs-keyword">var</span> sub_task_name = in_request;
      <span class="hljs-keyword">var</span> opts = grunt.config(current_sub_task_name) || {};
      <span class="hljs-keyword">if</span>( opts[current_target] ) opts[sub_task_name] = _.clone(opts[current_target], <span class="hljs-literal">true</span>)
      <span class="hljs-keyword">if</span>( !opts[sub_task_name] ) opts[sub_task_name] = {};
      <span class="hljs-keyword">if</span>( !opts[sub_task_name].options ) opts[sub_task_name].options = {};
      opts[sub_task_name].options.in_request = in_request;
      opts[sub_task_name].options.out = out_file;
      opts[sub_task_name].options.meta = meta_file;

      grunt.config.set(current_sub_task_name, opts);
      sub_tasks.push( current_sub_task_name+<span class="hljs-string">":"</span>+sub_task_name+<span class="hljs-string">":"</span>+current_target );
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_finalizer_builder</span><span class="hljs-params">( sub_tasks, in_request, out_file, build_assets, htmlcompressor )</span>{</span>

      <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-finalizer"</span>;
      <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};
      <span class="hljs-keyword">var</span> sub_task_name = <span class="hljs-string">"some-task"</span>+<span class="hljs-string">"-"</span>+sub_tasks.length;

      <span class="hljs-keyword">if</span>( !opts[sub_task_name] )
        opts[sub_task_name] = {
          options:{
            copy:{}
            ,meta_merge:{}
          }
        };

      opts[sub_task_name].options.copy[out_file] = out_file+<span class="hljs-string">".stryke"</span>;
      opts[sub_task_name].options.meta_merge[in_request] = [in_request+<span class="hljs-string">".stryke"</span>];
      <span class="hljs-keyword">if</span>(build_assets){
        opts[sub_task_name].options.copy[out_file] = out_file+<span class="hljs-string">".assets"</span>;
        opts[sub_task_name].options.meta_merge[in_request].push(in_request+<span class="hljs-string">".assets"</span>);
      }
      <span class="hljs-keyword">if</span>(htmlcompressor){
        opts[sub_task_name].options.copy[out_file] = out_file+<span class="hljs-string">".min"</span>;
        opts[sub_task_name].options.meta_merge[in_request].push(in_request+<span class="hljs-string">".min"</span>);
      }

      grunt.config.set(task_name, opts);
      sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name );
    }
  });</pre></div>
        
      
        
        <h2 id="builds-a-phantomizer-project">Builds a phantomizer project</h2>

        
      
        
        
        
          <div class='highlight'><pre>  grunt.registerMultiTask(<span class="hljs-string">"phantomizer-html-project-builder"</span>,
    <span class="hljs-string">"Builds an entire project with best performance"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span></pre></div>
        
      
        
        <p>this task is async</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">var</span> done = <span class="hljs-keyword">this</span>.async();

      <span class="hljs-keyword">var</span> ph_libutil = <span class="hljs-built_in">require</span>(<span class="hljs-string">"phantomizer-libutil"</span>);

      <span class="hljs-keyword">var</span> sub_tasks = [];</pre></div>
        
      
        
        <p>init default options</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">this</span>.options({</pre></div>
        
      
        
        <p>the path were all build assets results</p>

        
          <div class='highlight'><pre>        out_path:<span class="hljs-string">''</span>,</pre></div>
        
      
        
        <p>the path holding all build assets meta
the path to record temporarly url collection</p>

        
          <div class='highlight'><pre>        run_dir:<span class="hljs-string">''</span>,</pre></div>
        
      
        
        <p>the path used for webserver</p>

        
          <div class='highlight'><pre>        paths:[],</pre></div>
        
      
        
        <p>enable extras support scripts injection (dashbaord loader, test loader)</p>

        
          <div class='highlight'><pre>        inject_extras:<span class="hljs-literal">false</span>,</pre></div>
        
      
        
        <p>enable js,css,img build</p>

        
          <div class='highlight'><pre>        build_assets:<span class="hljs-literal">false</span>
      });
      grunt.verbose.writeflags(options,<span class="hljs-string">"options"</span>);

      <span class="hljs-keyword">var</span> current_target = <span class="hljs-keyword">this</span>.target;

      <span class="hljs-keyword">var</span> phantomizer = ph_libutil.get(<span class="hljs-string">"main"</span>);
      <span class="hljs-keyword">var</span> meta_manager = phantomizer.get_meta_manager();</pre></div>
        
      
        
        <p>initialize the router given the grunt config.routing key
router provides the catalog of urls to build</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">var</span> router = phantomizer.get_router();</pre></div>
        
      
        
        <p>load urls eventually from a remote service</p>

        
          <div class='highlight'><pre>      router.load(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div>
        
      
        
        <p>fetch urls to build</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">var</span> not_added = [];
        <span class="hljs-keyword">var</span> raw_urls = router.collect_urls(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(route)</span>{</span>
          <span class="hljs-keyword">if</span>( route.export == <span class="hljs-literal">false</span> ){
            not_added.push(route);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
          }
          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        });
        grunt.log.ok(<span class="hljs-string">"URL to export: "</span>+raw_urls.length+<span class="hljs-string">"/"</span>+(raw_urls.length+not_added.length));

        <span class="hljs-keyword">var</span> in_request;
        <span class="hljs-keyword">var</span> in_request_tgt;
        <span class="hljs-keyword">var</span> urls = [];
        <span class="hljs-keyword">for</span>( <span class="hljs-keyword">var</span> n <span class="hljs-keyword">in</span> raw_urls ){
          in_request = raw_urls[n];

          in_request_tgt = in_request+<span class="hljs-string">"-"</span>+current_target;
          <span class="hljs-keyword">var</span> meta_file = in_request_tgt;
          <span class="hljs-keyword">var</span> out_file = options.out_path+<span class="hljs-string">"/"</span>+in_request;

          out_file = path.normalize(out_file);
          meta_file = path.normalize(meta_file);

          <span class="hljs-keyword">if</span>( meta_manager.is_fresh(meta_file) == <span class="hljs-literal">false</span> ){
            urls.push({
              raw_in_request:raw_urls[n], <span class="hljs-comment">/* is exported for html-project-assets builder */</span>
              in_file:out_file, <span class="hljs-comment">/* is exported for html-project-assets builder */</span>
              in_request:in_request,
              out_file:out_file,
              meta_file:meta_file
            });
          }
        }

        <span class="hljs-keyword">var</span> urls_file = options.run_dir+<span class="hljs-string">"/tmp/html-builder-urls.json"</span>;
        grunt.file.mkdir( path.dirname(urls_file) );
        grunt.file.write(urls_file, <span class="hljs-built_in">JSON</span>.stringify(urls));

        queue_strykejs_builder( sub_tasks, current_target, urls_file, options.inject_extras );

        <span class="hljs-keyword">if</span>( options.build_assets ){
          queue_html_project_assets( sub_tasks, current_target, urls_file, options.out_path );
        }</pre></div>
        
      
        
        <p>helps to prevent odd error such :
Warning: Maximum call stack size exceeded Use â€”force to continue.</p>

        
          <div class='highlight'><pre>        sub_tasks.push( <span class="hljs-string">"throttle:20"</span> );

        <span class="hljs-keyword">if</span>( options.inject_extras == <span class="hljs-literal">true</span> ){
          queue_html_inject_extras_dir(  sub_tasks, current_target, options.out_path );
        }

        <span class="hljs-keyword">if</span>( options.build_assets ){
          queue_gm_merge(sub_tasks, current_target, options.paths, options.out_path);
        }
        queue_img_opt_dir(sub_tasks, current_target, options.paths, options.out_path);

        <span class="hljs-keyword">if</span>( options.build_assets ){
          queue_css_img_merge_dir(sub_tasks, current_target, options.out_path, options.out_path);
        }</pre></div>
        
      
        
        <p>-</p>

        
          <div class='highlight'><pre>        grunt.task.run( sub_tasks );
        grunt.log.ok();

        done();
      });

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_strykejs_builder</span><span class="hljs-params">( sub_tasks, sub_task_name, urls_file, inject_extras )</span>{</span>

        <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-strykejs-project-builder"</span>;
        <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};

        opts = clone_subtasks_options(opts, sub_task_name, current_target);
        opts[sub_task_name].options.urls_file = urls_file;
        opts[sub_task_name].options.inject_extras = inject_extras;

        grunt.config.set(task_name, opts);
        sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name );
      }

      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_html_project_assets</span><span class="hljs-params">( sub_tasks, current_target, urls_file, out_path )</span>{</span>

        <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-html-project-assets"</span>;
        <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};
        <span class="hljs-keyword">var</span> sub_task_name = task_name+<span class="hljs-string">"-"</span>+current_target;

        opts = clone_subtasks_options(opts, sub_task_name, current_target);
        opts[sub_task_name].options.urls_file = urls_file;
        opts[sub_task_name].options.as_of_target = current_target;
        opts[sub_task_name].options.out_path = out_path;

        grunt.config.set(task_name, opts)
        sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name )
      }
    });


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_html_assets</span><span class="hljs-params">( sub_tasks, current_target, in_request, in_file, meta_file, out_file, out_path )</span>{</span>

    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-html-assets"</span>;
    <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};
    <span class="hljs-keyword">var</span> sub_task_name = in_request+<span class="hljs-string">"-"</span>+current_target;

    opts = clone_subtasks_options(opts, sub_task_name, current_target);
    opts[sub_task_name].options.in_file = in_file;
    opts[sub_task_name].options.as_of_target = current_target;
    opts[sub_task_name].options.out = out_file;
    opts[sub_task_name].options.meta_file = meta_file;
    opts[sub_task_name].options.out_path = out_path;
    opts[sub_task_name].options.in_request = in_request;

    grunt.config.set(task_name, opts)
    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name )
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_html_min</span><span class="hljs-params">( sub_tasks, current_target, out_file, meta_file, in_file, in_request )</span>{</span>

    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-htmlcompressor"</span>;
    <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};
    <span class="hljs-keyword">var</span> sub_task_name = current_target+<span class="hljs-string">"-"</span>+in_request;

    opts = clone_subtasks_options(opts, sub_task_name, current_target);
    opts[sub_task_name].options.in_file = in_file;
    opts[sub_task_name].options.out = out_file;
    opts[sub_task_name].options.meta_file = meta_file;

    grunt.config.set(task_name, opts);
    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name );
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_html_inject_extras_dir</span><span class="hljs-params">( sub_tasks, current_target, in_dir )</span>{</span>

    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-dir-inject-html-extras"</span>;
    <span class="hljs-keyword">var</span> opts = grunt.config(task_name) || {};
    <span class="hljs-keyword">var</span> sub_task_name = current_target+<span class="hljs-string">"-"</span>+sub_tasks.length;

    opts = clone_subtasks_options(opts, sub_task_name, current_target);
    opts[sub_task_name].options.in_dir = in_dir+<span class="hljs-string">"/"</span>;

    grunt.config.set(task_name, opts);
    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+sub_task_name );
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_img_opt_dir</span><span class="hljs-params">( sub_tasks, build_target, paths, out_path )</span>{</span>

    <span class="hljs-keyword">var</span> jit_target = <span class="hljs-string">""</span>+build_target;
    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-dir-imgopt"</span>;
    <span class="hljs-keyword">var</span> task_options = grunt.config(task_name) || {};

    task_options = clone_subtasks_options(task_options, jit_target, build_target);
    <span class="hljs-keyword">if</span>(!task_options[jit_target].options) task_options[jit_target].options = {};
    task_options[jit_target].options.paths = paths;
    task_options[jit_target].options.out_path = out_path;

    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+jit_target );

    grunt.config.set(task_name, task_options);
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_css_img_merge_dir</span><span class="hljs-params">( sub_tasks, build_target, in_dir, out_dir )</span>{</span>

    <span class="hljs-keyword">var</span> merge_options = grunt.config(<span class="hljs-string">"phantomizer-gm-merge"</span>) || {};
    <span class="hljs-keyword">var</span> map = merge_options.options.in_files;

    <span class="hljs-keyword">var</span> jit_target = <span class="hljs-string">""</span>+build_target;
    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-dir-css-imgmerge"</span>;
    <span class="hljs-keyword">var</span> task_options = grunt.config(task_name) || {};

    task_options = clone_subtasks_options(task_options, jit_target, build_target);
    task_options[jit_target].options.paths = in_dir;
    task_options[jit_target].options.out_dir = out_dir;
    task_options[jit_target].options.map = map;

    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+jit_target );

    grunt.config.set(task_name, task_options);
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">queue_gm_merge</span><span class="hljs-params">( sub_tasks, build_target, paths, out_dir )</span>{</span>

    <span class="hljs-keyword">var</span> jit_target = <span class="hljs-string">""</span>+build_target;
    <span class="hljs-keyword">var</span> task_name = <span class="hljs-string">"phantomizer-gm-merge"</span>;
    <span class="hljs-keyword">var</span> task_options = grunt.config(task_name) || {};

    task_options = clone_subtasks_options(task_options, jit_target, build_target);

    <span class="hljs-keyword">if</span>( !task_options[jit_target].options )
      task_options[jit_target].options = {};
    task_options[jit_target].options.paths = paths;
    task_options[jit_target].options.out_dir = out_dir;

    sub_tasks.push( task_name+<span class="hljs-string">":"</span>+jit_target );

    grunt.config.set(task_name, task_options);
  }


  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone_subtasks_options</span><span class="hljs-params">(task_options, task_name, current_target)</span>{</span>
    <span class="hljs-keyword">var</span> _ = grunt.util._;
    <span class="hljs-keyword">if</span>( task_options[current_target] ) task_options[task_name] = _.clone(task_options[current_target], <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">if</span>( !task_options[task_name] ) task_options[task_name] = {};
    <span class="hljs-keyword">if</span>( !task_options[task_name].options ) task_options[task_name].options = {};
    <span class="hljs-keyword">return</span> task_options;
  }
};</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
